package gotest

import (
	"github.com/aws/aws-lambda-go/events"
	"github.com/thedevsaddam/gojsonq"
	"testing"
)

var CommentEventJson = `{ "comment": { "links": { "self": { "href": "https://api.bitbucket.org/2.0/repositories/sixleaveakkm/testwebhook/pullrequests/6/comments/96321570" }, "html": { "href": "https://bitbucket.org/sixleaveakkm/testwebhook/pull-requests/6/_/diff#comment-96321570" } }, "deleted": false, "pullrequest": { "type": "pullrequest", "id": 6, "links": { "self": { "href": "https://api.bitbucket.org/2.0/repositories/sixleaveakkm/testwebhook/pullrequests/6" }, "html": { "href": "https://bitbucket.org/sixleaveakkm/testwebhook/pull-requests/6" } }, "title": "Feature" }, "content": { "raw": "rebuild", "markup": "markdown", "html": "<p>rebuild</p>", "type": "rendered" }, "created_on": "2019-03-26T03:35:02.961293+00:00", "user": { "username": "sixleaveakkm", "display_name": "Di Wu", "account_id": "557058:71d2d09b-e8ff-4a2f-86b4-682f7b13208e", "links": { "self": { "href": "https://api.bitbucket.org/2.0/users/sixleaveakkm" }, "html": { "href": "https://bitbucket.org/sixleaveakkm/" }, "avatar": { "href": "https://bitbucket.org/account/sixleaveakkm/avatar/" } }, "nickname": "sixleaveakkm", "type": "user", "uuid": "{f69d65df-8ef2-4a07-86f0-5d50692dcb4e}" }, "updated_on": "2019-03-26T03:35:02.969553+00:00", "type": "pullrequest_comment", "id": 96321570 }, "pullrequest": { "rendered": { "description": { "raw": "* Merged in feat/fa \\(pull request #3\\)\r\n\r\n    Feat/fa\r\n\r\n\r\n\r\n    * sss\r\n    * a\r\n    * fa\r\n    \r\n* Merged in feat/fb \\(pull request #4\\)\r\n\r\n    Feat/fb\r\n\r\n\r\n\r\n    * sss\r\n    * a\r\n    * fb\r\n    \r\n* asdfwreq created online with Bitbucket", "markup": "markdown", "html": "<ul>\n<li>\n<p>Merged in feat/fa (pull request #3)</p>\n<p>Feat/fa</p>\n<ul>\n<li>sss</li>\n<li>a</li>\n<li>fa</li>\n</ul>\n</li>\n<li>\n<p>Merged in feat/fb (pull request #4)</p>\n<p>Feat/fb</p>\n<ul>\n<li>sss</li>\n<li>a</li>\n<li>fb</li>\n</ul>\n</li>\n<li>\n<p>asdfwreq created online with Bitbucket</p>\n</li>\n</ul>", "type": "rendered" }, "title": { "raw": "Feature", "markup": "markdown", "html": "<p>Feature</p>", "type": "rendered" } }, "type": "pullrequest", "description": "* Merged in feat/fa \\(pull request #3\\)\r\n\r\n    Feat/fa\r\n\r\n\r\n\r\n    * sss\r\n    * a\r\n    * fa\r\n    \r\n* Merged in feat/fb \\(pull request #4\\)\r\n\r\n    Feat/fb\r\n\r\n\r\n\r\n    * sss\r\n    * a\r\n    * fb\r\n    \r\n* asdfwreq created online with Bitbucket", "links": { "decline": { "href": "https://api.bitbucket.org/2.0/repositories/sixleaveakkm/testwebhook/pullrequests/6/decline" }, "commits": { "href": "https://api.bitbucket.org/2.0/repositories/sixleaveakkm/testwebhook/pullrequests/6/commits" }, "self": { "href": "https://api.bitbucket.org/2.0/repositories/sixleaveakkm/testwebhook/pullrequests/6" }, "comments": { "href": "https://api.bitbucket.org/2.0/repositories/sixleaveakkm/testwebhook/pullrequests/6/comments" }, "merge": { "href": "https://api.bitbucket.org/2.0/repositories/sixleaveakkm/testwebhook/pullrequests/6/merge" }, "html": { "href": "https://bitbucket.org/sixleaveakkm/testwebhook/pull-requests/6" }, "activity": { "href": "https://api.bitbucket.org/2.0/repositories/sixleaveakkm/testwebhook/pullrequests/6/activity" }, "diff": { "href": "https://api.bitbucket.org/2.0/repositories/sixleaveakkm/testwebhook/pullrequests/6/diff" }, "approve": { "href": "https://api.bitbucket.org/2.0/repositories/sixleaveakkm/testwebhook/pullrequests/6/approve" }, "statuses": { "href": "https://api.bitbucket.org/2.0/repositories/sixleaveakkm/testwebhook/pullrequests/6/statuses" } }, "title": "Feature", "close_source_branch": false, "reviewers": [], "id": 6, "destination": { "commit": { "hash": "4b2aef4c135f", "type": "commit", "links": { "self": { "href": "https://api.bitbucket.org/2.0/repositories/sixleaveakkm/testwebhook/commit/4b2aef4c135f" }, "html": { "href": "https://bitbucket.org/sixleaveakkm/testwebhook/commits/4b2aef4c135f" } } }, "repository": { "links": { "self": { "href": "https://api.bitbucket.org/2.0/repositories/sixleaveakkm/testwebhook" }, "html": { "href": "https://bitbucket.org/sixleaveakkm/testwebhook" }, "avatar": { "href": "https://bytebucket.org/ravatar/%7B4328e4a2-34a9-4fd8-8bba-75f105860a0a%7D?ts=default" } }, "type": "repository", "name": "testWebhook", "full_name": "sixleaveakkm/testwebhook", "uuid": "{4328e4a2-34a9-4fd8-8bba-75f105860a0a}" }, "branch": { "name": "develop" } }, "created_on": "2019-03-20T07:21:12.552963+00:00", "summary": { "raw": "* Merged in feat/fa \\(pull request #3\\)\r\n\r\n    Feat/fa\r\n\r\n\r\n\r\n    * sss\r\n    * a\r\n    * fa\r\n    \r\n* Merged in feat/fb \\(pull request #4\\)\r\n\r\n    Feat/fb\r\n\r\n\r\n\r\n    * sss\r\n    * a\r\n    * fb\r\n    \r\n* asdfwreq created online with Bitbucket", "markup": "markdown", "html": "<ul>\n<li>\n<p>Merged in feat/fa (pull request #3)</p>\n<p>Feat/fa</p>\n<ul>\n<li>sss</li>\n<li>a</li>\n<li>fa</li>\n</ul>\n</li>\n<li>\n<p>Merged in feat/fb (pull request #4)</p>\n<p>Feat/fb</p>\n<ul>\n<li>sss</li>\n<li>a</li>\n<li>fb</li>\n</ul>\n</li>\n<li>\n<p>asdfwreq created online with Bitbucket</p>\n</li>\n</ul>", "type": "rendered" }, "source": { "commit": { "hash": "171602dbccb0", "type": "commit", "links": { "self": { "href": "https://api.bitbucket.org/2.0/repositories/sixleaveakkm/testwebhook/commit/171602dbccb0" }, "html": { "href": "https://bitbucket.org/sixleaveakkm/testwebhook/commits/171602dbccb0" } } }, "repository": { "links": { "self": { "href": "https://api.bitbucket.org/2.0/repositories/sixleaveakkm/testwebhook" }, "html": { "href": "https://bitbucket.org/sixleaveakkm/testwebhook" }, "avatar": { "href": "https://bytebucket.org/ravatar/%7B4328e4a2-34a9-4fd8-8bba-75f105860a0a%7D?ts=default" } }, "type": "repository", "name": "testWebhook", "full_name": "sixleaveakkm/testwebhook", "uuid": "{4328e4a2-34a9-4fd8-8bba-75f105860a0a}" }, "branch": { "name": "feature" } }, "comment_count": 6, "state": "OPEN", "task_count": 1, "participants": [ { "role": "PARTICIPANT", "participated_on": "2019-03-26T03:35:02.969553+00:00", "type": "participant", "approved": false, "user": { "username": "sixleaveakkm", "display_name": "Di Wu", "account_id": "557058:71d2d09b-e8ff-4a2f-86b4-682f7b13208e", "links": { "self": { "href": "https://api.bitbucket.org/2.0/users/sixleaveakkm" }, "html": { "href": "https://bitbucket.org/sixleaveakkm/" }, "avatar": { "href": "https://bitbucket.org/account/sixleaveakkm/avatar/" } }, "nickname": "sixleaveakkm", "type": "user", "uuid": "{f69d65df-8ef2-4a07-86f0-5d50692dcb4e}" } } ], "reason": "", "updated_on": "2019-03-26T03:35:02.974907+00:00", "author": { "username": "sixleaveakkm", "display_name": "Di Wu", "account_id": "557058:71d2d09b-e8ff-4a2f-86b4-682f7b13208e", "links": { "self": { "href": "https://api.bitbucket.org/2.0/users/sixleaveakkm" }, "html": { "href": "https://bitbucket.org/sixleaveakkm/" }, "avatar": { "href": "https://bitbucket.org/account/sixleaveakkm/avatar/" } }, "nickname": "sixleaveakkm", "type": "user", "uuid": "{f69d65df-8ef2-4a07-86f0-5d50692dcb4e}" }, "merge_commit": null, "closed_by": null }, "repository": { "scm": "git", "website": "", "name": "testWebhook", "links": { "self": { "href": "https://api.bitbucket.org/2.0/repositories/sixleaveakkm/testwebhook" }, "html": { "href": "https://bitbucket.org/sixleaveakkm/testwebhook" }, "avatar": { "href": "https://bytebucket.org/ravatar/%7B4328e4a2-34a9-4fd8-8bba-75f105860a0a%7D?ts=default" } }, "full_name": "sixleaveakkm/testwebhook", "owner": { "username": "sixleaveakkm", "display_name": "Di Wu", "account_id": "557058:71d2d09b-e8ff-4a2f-86b4-682f7b13208e", "links": { "self": { "href": "https://api.bitbucket.org/2.0/users/sixleaveakkm" }, "html": { "href": "https://bitbucket.org/sixleaveakkm/" }, "avatar": { "href": "https://bitbucket.org/account/sixleaveakkm/avatar/" } }, "nickname": "sixleaveakkm", "type": "user", "uuid": "{f69d65df-8ef2-4a07-86f0-5d50692dcb4e}" }, "type": "repository", "is_private": true, "uuid": "{4328e4a2-34a9-4fd8-8bba-75f105860a0a}" }, "actor": { "username": "sixleaveakkm", "display_name": "Di Wu", "account_id": "557058:71d2d09b-e8ff-4a2f-86b4-682f7b13208e", "links": { "self": { "href": "https://api.bitbucket.org/2.0/users/sixleaveakkm" }, "html": { "href": "https://bitbucket.org/sixleaveakkm/" }, "avatar": { "href": "https://bitbucket.org/account/sixleaveakkm/avatar/" } }, "nickname": "sixleaveakkm", "type": "user", "uuid": "{f69d65df-8ef2-4a07-86f0-5d50692dcb4e}" } }`

func Test_HookEvent(t *testing.T) {
	request := new(events.APIGatewayProxyRequest)
	request.Body = CommentEventJson

	t.Logf("request.Body: %v", request.Body)
	repoURL := gojsonq.New().JSONString(request.Body).Find("repository.links.html.href")
	if repoURL == nil {
		t.Error("failed get repourl")
	} else {
		t.Log("Succ")
	}
}
